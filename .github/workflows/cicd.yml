name: Deploy to EC2

on:
  push:
    branches:
      - deploy

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Log in to OCI Registry
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login kix.ocir.io -u "${{ secrets.OCI_USERNAME }}" --password-stdin

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github
          chmod 600 ~/.ssh/github
          echo "Host ec2" >> ~/.ssh/config
          echo "  HostName ${{ secrets.SSH_HOST }}" >> ~/.ssh/config
          echo "  User ubuntu" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/github" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Create .env (NGINX)
        run: echo "${{ secrets.ENV_FILE_NGINX }}" > apps/nginx/.env

      - name: Create .env (WEB)
        run: echo "${{ secrets.ENV_FILE }}" > apps/web/.env

      - name: Create .env (API)
        run: echo "${{ secrets.ENV_FILE_WORKER }}" > apps/api/.env

      - name: Create .env (WORKER)
        run: echo "${{ secrets.ENV_FILE_WORKER }}" > apps/worker/.env

      - name: Copy files
        run: |
          scp -r -o StrictHostKeyChecking=no -i ~/.ssh/github apps/ ubuntu@${{ secrets.SSH_HOST }}:~/app/

      - name: Determine Active
        id: active_version
        run: |
          ACTIVE=$(ssh ec2 "docker ps --format '{{.Names}}' | grep -q 'app-blue' && echo blue || echo green")
          echo "ACTIVE=$ACTIVE" >> $GITHUB_ENV
          if [[ \"$ACTIVE\" == \"blue\" ]]; then
              echo "NEW=green" >> $GITHUB_ENV
          else
              echo "NEW=blue" >> $GITHUB_ENV
          fi

      - name: Check GITHUB_ENV
        run: echo $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Cache for Turbo
        uses: rharkor/caching-for-turbo@v1.8

      - name: Install Dependencies
        run: pnpm install

      - name: Run Lint
        run: pnpm turbo run lint

      - name: Run Test
        run: pnpm --filter ./apps/web test
        env:
          ENCRYPTION_SECRET: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

      - name: Prisma generate (for db)
        working-directory: packages/db
        run: pnpm prisma generate

      - name: Turbo Build
        run: pnpm turbo run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Image (WEB)
        uses: docker/build-push-action@v6
        with:
          file: ./apps/web/Dockerfile
          context: .
          push: true
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            kix.ocir.io/axunckhvyv1v/logme-app:${{ env.NEW }}
            kix.ocir.io/axunckhvyv1v/logme-app:latest

      - name: Build and Push Image (API)
        uses: docker/build-push-action@v6
        with:
          file: ./apps/api/Dockerfile
          context: .
          push: true
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            kix.ocir.io/axunckhvyv1v/logme-api:latest

      - name: Build and Push Image (WORKER)
        uses: docker/build-push-action@v6
        with:
          file: ./apps/worker/Dockerfile
          context: .
          push: true
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            kix.ocir.io/axunckhvyv1v/logme-worker:latest

      - name: Ensure Vector container is running
        run: |
          ssh ec2 << 'EOF'
          if ! docker ps --format '{{.Names}}' | grep -q "vector"; then
            echo "üîß Vector Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§Ìñâ Ï§ëÏù¥ ÏïÑÎãôÎãàÎã§. Ïû¨ÏãúÏûëÌï©ÎãàÎã§..."
            cd ~/app
            docker-compose up -d vector
          else
            echo "‚úÖ Vector Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ï§ë"
          fi
          EOF

      - name: Deploy on EC2
        run: |
          ssh ec2 << 'EOF'
          set -e

          rollback() {
              echo "‚ùå Î∞∞Ìè¨ Ïã§Ìå®! Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑàÎ°ú ÏõêÎ≥µ Ï§ë..."
              docker-compose kill app-${{ env.NEW }}
              docker-compose rm -f app-${{ env.NEW }}

              docker system prune -a -f
              exit 1
          }
          cleanup() {
              echo "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ! Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ Ï§ë..."
              docker-compose kill app-${{ env.ACTIVE }}
              docker-compose rm -f app-${{ env.ACTIVE }}

              sleep 5
              docker system prune -a -f
          }
          trap rollback ERR

          cd ~/app

          echo "ÌòÑÏû¨ Ïª®ÌÖåÏù¥ÎÑà: $(docker ps --format '{{.Names}}')"

          # Ïù¥ Î∂ÄÎ∂ÑÏù¥ Ï§ëÏöîÌñàÏùå! git pull Î∂ÄÎ∂Ñ ÏÇ≠Ï†úÌïòÍ≥†, .envÍ∞Ä ÏóÜÏñ¥ÏÑú docker-compose.yamlÏùò ACTIVE Î≥ÄÏàòÍ∞Ä ""Î°ú Î∞îÎÄåÎäî Î∞îÎûåÏóê 
          # docker-compose Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä nginx depends_on: app- ÏúºÎ°ú Ìï¥ÏÑùÎêòÏñ¥ Íµ¨Î¨∏ Ïò§Î•ò Î∞úÏÉù
          echo "ACTIVE=${{ env.ACTIVE }}" > .env

          docker-compose pull app-${{ env.NEW }}
          docker-compose up -d app-${{ env.NEW }}

          sleep 10

          # Health check
          if docker ps --format '{{.Names}}' | grep -q "nginx"; then
              echo "‚úÖ Nginx Ïã§Ìñâ Ï§ë! Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ìó¨Ïä§ Ï≤¥ÌÅ¨ ÏàòÌñâ..."
              sleep 10
              if curl -f http://localhost:3000/api/health | grep -q '"status":"ok"'; then
                  echo "‚úÖ Ïï± Ìó¨Ïä§ Ï≤¥ÌÅ¨ ÏÑ±Í≥µ!"
              else
                  echo "‚ùå Ïï± Ìó¨Ïä§ Ï≤¥ÌÅ¨ Ïã§Ìå®! Î°§Î∞± ÏàòÌñâ"
                  rollback
              fi
          else
              echo "‚ö†Ô∏è Nginx ÎØ∏Ïã§Ìñâ! Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉúÎ°ú Ìó¨Ïä§ Ï≤¥ÌÅ¨ ÏßÑÌñâ..."
              sleep 5
              docker ps --format '{{.Names}}' | grep -q "app-${{ env.NEW }}" || rollback
              echo "‚úÖ app-${{ env.NEW}} Ïª®ÌÖåÏù¥ÎÑà Ï†ïÏÉÅ Ïã§Ìñâ Ï§ë!"
          fi

          echo "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ!"
          echo "ACTIVE=${{ env.NEW }}" > .env
          export $(grep -v '^#' .env | xargs)
          echo "${{ env.ACTIVE }} -> $ACTIVE"

          cleanup

          docker ps --format '{{.Names}}' | grep -q "nginx" && docker-compose exec -e ACTIVE="$ACTIVE" nginx /bin/sh -c "envsubst '\$ACTIVE' < /etc/nginx/nginx.conf.template.ssl > /etc/nginx/nginx.conf && nginx -t && nginx -s reload" || docker-compose up -d --force-recreate nginx
          docker ps --format '{{.Names}}' | grep -q "api" || docker-compose up -d --force-recreate api
          docker ps --format '{{.Names}}' | grep -q "worker" || docker-compose up -d --force-recreate worker

          EOF

      - name: Slack Notification (Success)
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ: '${{ github.repository }}' Î∏åÎûúÏπò '${{ github.ref_name }}'"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notification (Failure)
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚ùå Î∞∞Ìè¨ Ïã§Ìå®: '${{ github.repository }}' Î∏åÎûúÏπò '${{ github.ref_name }}' ÌôïÏù∏ ÌïÑÏöî!"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
